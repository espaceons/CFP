{% extends 'base.html' %}

{% block title %}
  {{ titre_page }}
{% endblock %}

{% block content %}
  <div class="container mt-4">
    <h1 class="mb-4 border-bottom pb-2 text-primary">{{ titre_page }}</h1>
    {# ---------------------------------------------------- #}

    <p class="lead text-muted">
      Session : <strong>{{ session.nom_session }}</strong> ({{ session.formation.nom }})
      <br />
      ðŸ“… DÃ©but : **{{ session.date_debut_session|date:'d F Y' }}** | Fin : **{{ session.date_fin_session|date:'d F Y' }}**
    </p>

    <form method="post" class="needs-validation" novalidate>
      {% csrf_token %}

      {# Le Management Form est crucial pour le formset #}
      {{ formset.management_form }}

      {# Affichage des erreurs globales du Formset #}
      {% if formset.non_form_errors %}
        <div class="alert alert-danger" role="alert">
          <h4 class="alert-heading">Erreurs globales</h4>
          <ul>
            {% for error in formset.non_form_errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      {# Boucle sur chaque formulaire de sÃ©ance #}
      {% for form in formset %}
        <div class="seance-form mb-5 p-4 border rounded shadow-sm bg-white">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="h5 m-0 text-primary">SÃ©ance #{{ forloop.counter }}</h3>

            {# Rendu du champ session masquÃ© (CRITIQUE pour la sauvegarde) #}
            {{ form.session }}

            {# Exemple pour un champ de suppression (si can_delete=True) #}
            {% if form.DELETE %}
              <div class="form-check form-check-inline">
                {{ form.DELETE }}
                <label class="form-check-label text-danger" for="{{ form.DELETE.id_for_label }}">Supprimer</label>
              </div>
            {% endif %}
          </div>

          {# Affichage des erreurs spÃ©cifiques Ã  ce formulaire #}
          {% if form.errors %}
            <div class="alert alert-warning py-2 small" role="alert">
              <strong>Erreurs pour cette sÃ©ance :</strong>
              {# Boucle sur les erreurs de champs (nÃ©cessite un filtre get_item si vous l'utilisez) #}
              {{ form.errors }}
            </div>
          {% endif %}

          {# ðŸ›‘ RENDU MANUEL AVEC GRILLE BOOTSTRAP ðŸ›‘ #}
          <div class="row">
            {# Colonne 1 : Date, Heures, Instructeur #}
            <div class="col-md-6">
              {% for field in form.visible_fields|slice:':4' %}
                <div class="mb-3">
                  {{ field.label_tag }}
                  {{ field }}
                  {% if field.help_text %}
                    <small class="form-text text-muted">{{ field.help_text }}</small>
                  {% endif %}
                  {# Afficher les erreurs spÃ©cifiques au champ #}
                  {% for error in field.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                  {% endfor %}
                </div>
              {% endfor %}
            </div>

            {# Colonne 2 : Salle, Sujet, etc. #}
            <div class="col-md-6">
              {% for field in form.visible_fields|slice:'4:6' %}
                <div class="mb-3">
                  {{ field.label_tag }}
                  {{ field }}
                  {% if field.help_text %}
                    <small class="form-text text-muted">{{ field.help_text }}</small>
                  {% endif %}
                  {% for error in field.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                  {% endfor %}
                </div>
              {% endfor %}
            </div>
          </div>

          {# Champ de texte Ã©tendu (Note ou Sujet Aborde) #}
          <div class="mb-3">{{ form.sujet_aborde.label_tag }}
            {{ form.sujet_aborde }}</div>

          {# Champs restants (Note et Annulation) #}
          <div class="row">
            <div class="col-md-12">{{ form.note_seance.label_tag }}
              {{ form.note_seance }}</div>
          </div>

          <div class="mb-3 form-check mt-3">{{ form.est_annulee }} {{ form.est_annulee.label_tag }}</div>
        </div>
      {% endfor %}

      {# Boutons de soumission et d'annulation #}
      <div class="d-flex justify-content-start gap-2 mt-4 pb-5">
        <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-save me-2"></i> Enregistrer les sÃ©ances</button>
        <a href="{% url 'gestion_formations:session_detail' pk=session.pk %}" class="btn btn-secondary btn-lg"><i class="fas fa-times me-2"></i> Annuler</a>
      </div>
    </form>
  </div>
{% endblock %}
